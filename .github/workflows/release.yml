name: Create Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            version:
                description: "Release version (e.g., v1.2.3)"
                required: true
                type: string

permissions:
    contents: write
    pull-requests: read

jobs:
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get version
              id: version
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
                  else
                    echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                  fi

            - name: Generate changelog
              id: changelog
              uses: mikepenz/release-changelog-builder-action@v4
              with:
                  configuration: ".github/release-config.json"
                  toTag: ${{ steps.version.outputs.version }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.version.outputs.version }}
                  name: Release ${{ steps.version.outputs.version }}
                  body: |
                      ## Release ${{ steps.version.outputs.version }}

                      ${{ steps.changelog.outputs.changelog }}

                      ---

                      **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.changelog.outputs.fromTag }}...${{ steps.version.outputs.version }}

                      ### Installation

                      ```bash
                      git clone https://github.com/${{ github.repository }}.git
                      cd sogangcomputerclub.org
                      git checkout ${{ steps.version.outputs.version }}
                      ```
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.version, '-') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Notify on success
              if: success()
              run: |
                  echo "Release ${{ steps.version.outputs.version }} created successfully!"
                  echo "View release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
