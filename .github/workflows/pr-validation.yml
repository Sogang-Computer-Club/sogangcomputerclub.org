name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  pull-requests: write
  contents: read
  statuses: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const body = pr.body || '';
            const minLength = 50;

            // Check if PR has a description
            if (body.length < minLength) {
              core.setFailed(`PR description is too short (${body.length} chars). Please provide at least ${minLength} characters describing your changes.`);
              return;
            }

            // Check for required sections
            const requiredSections = [
              { name: 'Description', alternatives: ['Description', '설명'] },
              { name: 'Type of Change', alternatives: ['Type of Change', '변경 유형'] },
              { name: 'Testing', alternatives: ['Testing', '테스트'] }
            ];

            const missingSections = requiredSections.filter(section => 
              !section.alternatives.some(alt => body.includes(alt))
            );

            if (missingSections.length > 0) {
              const missingNames = missingSections.map(s => `${s.name} (or ${s.alternatives[1]})`);
              core.setFailed(`PR description is missing required sections: ${missingNames.join(', ')}`);
              return;
            }

            console.log('PR description validation passed');

      - name: Check for merge conflicts
        uses: eps1lon/actions-label-merge-conflict@v3
        with:
          dirtyLabel: "merge-conflict"
          repoToken: "${{ secrets.GITHUB_TOKEN }}"

      - name: Validate branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix|fix|docs|refactor|test|chore)/.+ ]]; then
            echo "Branch name must follow pattern: feature/*, bugfix/*, hotfix/*, fix/*, docs/*, refactor/*, test/*, or chore/*"
            echo "Current branch: $BRANCH_NAME"
            exit 1
          fi
          echo "Branch name is valid: $BRANCH_NAME"

      - name: Check file size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const maxSize = 5 * 1024 * 1024; // 5MB
            const largeFiles = files.filter(file => file.changes > 1000 || file.additions > 500);

            if (largeFiles.length > 0) {
              const fileList = largeFiles.map(f => `- ${f.filename} (${f.additions} additions, ${f.deletions} deletions)`).join('\n');
              core.warning(`Large files detected:\n${fileList}\n\nConsider breaking this PR into smaller chunks.`);
            } else {
              console.log('File size check passed');
            }

      - name: Comment validation result
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**PR Validation Passed**\n\nYour pull request has passed all automated validation checks. It will now be reviewed by maintainers.'
            });
